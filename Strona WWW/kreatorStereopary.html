<!DOCTYPE html>
<html lang="pl">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148359652-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', 'UA-148359652-2');
    </script>
    <!-- End Google site tag (gtag.js) - Google Analytics -->

    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="Description" content="CARDBLOCKS - kreator stereopar do druku">
    <meta name="Url" content="http://www.cardblocks.com">
    <meta name="Robots" content="ALL">
    <meta name="Author" content="webdesign - LIGATURA">
    <meta name="Keywords" content="stereopara, druk 3D, cardblocks, kreator stereopary">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="copyright" content="khanalprem">

    <title>CARDBLOCKS - Utwórz stereoparę 3D</title>

    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/owl.carousel.min.css">
    <link rel="stylesheet" type="text/css" href="css/magnific-popup.css">
    <link rel="stylesheet" type="text/css" href="css/jquery.fancybox.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.css">
    <link rel="stylesheet" type="text/css" href="css/style-ws.css">
    <link rel="stylesheet" type="text/css" href="css/lightbox.css">

    <link href='https://fonts.googleapis.com/css?family=Roboto:100,200,300,400,500,600,600italic,700,700italic,800' rel='stylesheet' type='text/css'>

    <link rel="icon" href="images/favicon.ico" type="image/ico">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="ico/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style>
        :root {
            --stereopair-workspace-width: 12.5cm;
            --stereopair-workspace-height: 11cm;
            --stereopair-column-gap: 30.24px;
            --stereopair-row-gap: 45.36px;
            --stereopair-workspace-bg: #ffffff;
        }

        .stereopair-generator {
            background: #f6f8fb;
            padding: 60px 0 80px;
        }

        .stereopair-intro {
            max-width: 720px;
            margin: 0 auto 40px auto;
        }

        .stereopair-intro h3 {
            font-weight: 600;
            color: #062d55;
            margin-bottom: 15px;
        }

        .stereopair-intro p {
            font-size: 16px;
            color: #4c5c73;
            margin-bottom: 0;
        }

        .stereopair-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: flex-start;
        }

        .stereopair-panel,
        .stereopair-preview {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 18px 48px rgba(6, 45, 85, 0.08);
            padding: 32px;
            flex: 1 1 360px;
        }

        .stereopair-panel {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .stereopair-section h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #062d55;
            font-weight: 600;
        }

        .stereopair-field {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-weight: 600;
            color: #062d55;
            margin-bottom: 16px;
        }

        .stereopair-field-label {
            font-size: 14px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: #4c5c73;
        }

        .stereopair-select,
        .stereopair-panel input[type="file"],
        .stereopair-panel input[type="number"] {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #d4deed;
            background: #f8fbff;
            padding: 10px 14px;
            font-size: 15px;
            color: #062d55;
        }

        .stereopair-panel input[type="file"] {
            padding: 12px 14px;
            background: #ffffff;
        }

        .stereopair-panel input[type="file"]::file-selector-button {
            background: #062d55;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            margin-right: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .stereopair-panel input[type="number"] {
            max-width: 100px;
        }

        .stereopair-slider-inputs {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .stereopair-slider-inputs input[type="range"] {
            flex: 1 1 240px;
        }

        .stereopair-color-picker {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .stereopair-color-picker input[type="color"] {
            width: 56px;
            height: 36px;
            border: none;
            border-radius: 10px;
            padding: 0;
            cursor: pointer;
        }

        .stereopair-helper-text {
            font-size: 13px;
            color: #7a8799;
            margin: -10px 0 0 0;
        }

        .stereopair-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stereopair-action-button {
            background: #062d55;
            border: none;
            border-radius: 10px;
            padding: 10px 24px;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .stereopair-action-button:hover {
            background: #0c3c7b;
            transform: translateY(-1px);
        }

        .stereopair-action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stereopair-action-button.secondary {
            background: #c4d114;
            color: #062d55;
        }

        .stereopair-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .stereopair-preview-header {
            width: 100%;
            text-align: center;
        }

        .stereopair-workspace-label {
            font-weight: 600;
            color: #4c5c73;
            letter-spacing: 0.02em;
        }

        .stereopair-workspace {
            width: var(--stereopair-workspace-width);
            height: var(--stereopair-workspace-height);
            background: var(--stereopair-workspace-bg);
            border-radius: 18px;
            border: 1px solid rgba(6, 45, 85, 0.18);
            box-shadow: 0 22px 52px rgba(6, 45, 85, 0.12);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            column-gap: var(--stereopair-column-gap);
            row-gap: var(--stereopair-row-gap);
            padding: 16px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(circle at top left, rgba(255, 255, 255, 0.45), transparent 55%);
        }

        .stereopair-workspace::before {
            content: "";
            position: absolute;
            left: 16px;
            right: 16px;
            top: calc(50% - var(--stereopair-row-gap) / 2);
            border-top: 2px dotted rgba(6, 45, 85, 0.25);
            pointer-events: none;
        }

        .stereopair-image-half {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            background-color: rgba(6, 45, 85, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(6, 45, 85, 0.45);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        .stereopair-image-half img {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            object-fit: cover;
            object-position: center;
            display: none;
        }

        .stereopair-image-half.filled {
            color: transparent;
        }

        .stereopair-image-half.filled img {
            display: block;
        }

        .stereopair-image-half-left img {
            object-position: left center;
        }

        .stereopair-image-half-right img {
            object-position: right center;
        }

        @media (max-width: 991px) {
            .stereopair-content {
                flex-direction: column;
            }

            .stereopair-panel,
            .stereopair-preview {
                width: 100%;
            }

            .stereopair-panel,
            .stereopair-preview {
                padding: 26px;
            }
        }

        @media (max-width: 767px) {
            .stereopair-generator {
                padding: 40px 0 60px;
            }

            .stereopair-workspace {
                width: min(var(--stereopair-workspace-width), 100%);
            }
        }

        @media print {
            body {
                background: #ffffff;
                padding: 0;
            }

            header,
            .amplebiz-breadcrumb,
            .stereopair-intro,
            .stereopair-panel,
            .stereopair-actions,
            footer,
            .footer-bottom,
            .scroll-top {
                display: none !important;
            }

            .stereopair-generator {
                padding: 0;
                background: #ffffff;
            }

            .stereopair-preview {
                box-shadow: none;
                background: transparent;
                padding: 0;
            }

            .stereopair-workspace {
                box-shadow: none;
                border: none;
                background-image: none;
            }
        }
    </style>
    <style id="stereopairPrintStyles"></style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W35CGB9" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!--header start-->
    <header class="main-header">
        <!--top-header-->
        <div class="top-header">
            <div class="container">
                <div class="logo-wrapper">
                    <a href="index.html"><img src="images/rsc-logo2.png" alt="CARDBLOCKS - logo" title="CARDBLOCKS - logo"></a>
                </div>
                <!-- Main Menu -->
                <nav class="main-menu">
                    <div class="navbar-header">
                        <!-- Toggle Button -->
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                    </div>

                    <div class="navbar-collapse collapse clearfix">
                        <ul class="navigation clearfix">
                            <li><a href="index.html">HOME</a></li>
                            <li><a href="system.html">ELEMENTY SYSTEMU</a></li>
                            <li><a href="oferta.html">OFERTA</a></li>
                            <li><a href="modele-01.html">MODELE</a></li>
                            <li><a href="kreator.html">KREATOR</a></li>
                            <li><a href="of-bp-s.html">PREMIUM BOX</a></li>
                            <li class="dropdown current"><a href="javascript:void(0);" aria-haspopup="true">3D</a>
                                <ul>
                                    <li class="current"><a href="kreatorStereopary.html">Utwórz stereoparę</a></li>
                                </ul>
                            </li>
                            <li><a href="kontakt.html">KONTAKT</a></li>
                            <li><a target="_blank" href="https://sklep.cardblocks.com/pl/c/Klocki-konstrukcyjne/13">SKLEP</a></li>
                        </ul>
                    </div>
                </nav>
                <!-- Main Menu End-->
            </div>
        </div>

    </header>
    <!--header end-->

    <!-- breadcrumb start -->
    <section class="amplebiz-breadcrumb" style="background: url(images/background/bg-02.jpg) no-repeat center;">
        <div class="amplebiz-breadcrumb-overlay"></div>
        <div class="amplebiz-breadcrumb-title"><p class="p07">&nbsp;</p>
            <h1><div class="p30">UTWÓRZ STEREOPARĘ</div></h1>
            <p><a href="index.html">Home</a><a href="kreatorStereopary.html">Utwórz stereoparę</a></p>
        </div>
    </section>
    <!-- breadcrumb end -->
    <div class="clearfix"></div>

    <div class="stereopair-generator page">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="stereopair-intro text-center">
                        <h3 id="stereopairHeading">Utwórz stereoparę do druku</h3>
                        <p>Wgraj dwa ujęcia i przygotuj wydruk dopasowany do formatu drukarki fotograficznej. Wybierz szablon, ustaw odstępy i pobierz gotowy plik.</p>
                    </div>
                </div>
            </div>
            <div class="stereopair-content">
                <div class="stereopair-panel">
                    <section class="stereopair-section">
                        <h2>Parametry wydruku</h2>
                        <label class="stereopair-field" for="templateSelect">
                            <span class="stereopair-field-label">Szablon druku dla</span>
                            <select id="templateSelect" class="stereopair-select">
                                <option value="canon-selphy-1500">Canon SELPHY 1500</option>
                            </select>
                        </label>
                        <p class="stereopair-helper-text">Domyślne ustawienia obejmują format arkusza, układ zdjęć oraz odstępy właściwe dla wybranego urządzenia.</p>
                    </section>

                    <section class="stereopair-section">
                        <h2>Wgraj zdjęcia</h2>
                        <label class="stereopair-field" for="photo1">
                            <span class="stereopair-field-label">Zdjęcie 1</span>
                            <input type="file" id="photo1" accept="image/*" />
                        </label>
                        <label class="stereopair-field" for="photo2">
                            <span class="stereopair-field-label">Zdjęcie 2</span>
                            <input type="file" id="photo2" accept="image/*" />
                        </label>
                    </section>

                    <section class="stereopair-section">
                        <h2>Ustaw odstępy</h2>
                        <div class="stereopair-slider">
                            <label class="stereopair-field" for="columnGapRange">
                                <span class="stereopair-field-label">Odstęp między kolumnami (mm)</span>
                                <div class="stereopair-slider-inputs">
                                    <input type="range" id="columnGapRange" min="0" max="30" value="8" step="1" />
                                    <input type="number" id="columnGapNumber" min="0" max="30" value="8" step="1" />
                                </div>
                            </label>
                        </div>
                        <div class="stereopair-slider">
                            <label class="stereopair-field" for="rowGapRange">
                                <span class="stereopair-field-label">Odstęp między wierszami (mm)</span>
                                <div class="stereopair-slider-inputs">
                                    <input type="range" id="rowGapRange" min="0" max="30" value="12" step="1" />
                                    <input type="number" id="rowGapNumber" min="0" max="30" value="12" step="1" />
                                </div>
                            </label>
                        </div>
                    </section>

                    <section class="stereopair-section">
                        <h2>Kolor tła</h2>
                        <label class="stereopair-field stereopair-color-picker" for="backgroundColor">
                            <span class="stereopair-field-label">Wybierz kolor</span>
                            <input type="color" id="backgroundColor" value="#ffffff" />
                        </label>
                    </section>

                    <section class="stereopair-section">
                        <h2>Eksport</h2>
                        <div class="stereopair-actions">
                            <button type="button" id="saveImage" class="stereopair-action-button">Zapisz jako obraz</button>
                            <button type="button" id="printWorkspace" class="stereopair-action-button secondary">Drukuj</button>
                        </div>
                    </section>
                </div>

                <div class="stereopair-preview">
                    <div class="stereopair-preview-header">
                        <span class="stereopair-workspace-label" id="workspaceLabel">Obszar roboczy 12,5×11 cm</span>
                    </div>
                    <div class="stereopair-workspace" id="workspace">
                        <div class="stereopair-image-half stereopair-image-half-left" id="photo1-left">
                            Zdjęcie 1
                            <img alt="Lewa połowa zdjęcia 1" />
                        </div>
                        <div class="stereopair-image-half stereopair-image-half-right" id="photo1-right">
                            Zdjęcie 1
                            <img alt="Prawa połowa zdjęcia 1" />
                        </div>
                        <div class="stereopair-image-half stereopair-image-half-left" id="photo2-left">
                            Zdjęcie 2
                            <img alt="Lewa połowa zdjęcia 2" />
                        </div>
                        <div class="stereopair-image-half stereopair-image-half-right" id="photo2-right">
                            Zdjęcie 2
                            <img alt="Prawa połowa zdjęcia 2" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Footer-->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-2 col-sm-12 col-xs-12 footer-column">
                    <div class="footer-widget links-widget">
                        <h2><a href="system.html">Elementy systemu</a></h2>
                        <div class="row">
                            <div class="col-sm-12">
                                <ul>
                                    <li><a href="es-klocek-s1.html">Klocek S1</a></li>
                                    <li><a href="es-lacznik-x1.html">Łącznik X1</a></li>
                                    <li><a href="es-wspornik-a9.html">Wspornik A9</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-12 col-xs-12 footer-column">
                    <div class="footer-widget links-widget">
                        <h2><a href="oferta.html">Oferta</a></h2>
                        <div class="row">
                            <div class="col-sm-12">
                                <ul>
                                    <li><a href="of-rsc-050.html"><b>KLOCKI KONSTRUKCYJNE</b> 50</a></li>
                                    <li><a href="of-k-036-1.html"><b>KOPUŁA</b> &empty; 36 cm</a></li>
                                    <li><a href="of-ra-036-1.html"><b>ROTUNDA</b></a></li>
                                    <li><a href="of-dodatek-1.html"><b>ZESTAW 1</b></a></li>
                                    <li><a href="of-bp-s.html"><b>BRYŁY PLATOŃSKIE</b></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </footer>
    <!-- end Footer-->

    <!--Footer Bottom-->
    <div class="footer-bottom">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-md-6">
                    <div class="text text-left" style="font-size: 10px;">Copyrights &copy; 2017 AmpleBiz. All Rights Reserved</div>
                </div>
                <div class="col-sm-6 col-md-6">
                    <div class="text text-right" style="font-size: 10px;">Copyrights &copy; 2019 LIGATURA</div>
                </div>
            </div>
        </div>
    </div>

    <!-- end Footer Bottom-->

    <!-- scroll top -->
    <a class="scroll-top fa fa-angle-up" style="text-decoration: none;" href="javascript:void(0)"></a>
    <!-- srolltop end -->

    <script>
        const CSS_DPI = 96;
        const PRINT_DPI = 300;
        const CM_TO_INCH = 1 / 2.54;

        const workspace = document.getElementById('workspace');
        const workspaceLabel = document.getElementById('workspaceLabel');
        const printStyleElement = document.getElementById('stereopairPrintStyles');
        const templateSelect = document.getElementById('templateSelect');
        const columnGapRange = document.getElementById('columnGapRange');
        const columnGapNumber = document.getElementById('columnGapNumber');
        const rowGapRange = document.getElementById('rowGapRange');
        const rowGapNumber = document.getElementById('rowGapNumber');
        const backgroundColorPicker = document.getElementById('backgroundColor');
        const saveImageButton = document.getElementById('saveImage');
        const printButton = document.getElementById('printWorkspace');

        if (!workspace) {
            throw new Error('Brak obszaru roboczego do wyświetlenia stereopary.');
        }

        const mmToPx = (mm) => mm * (CSS_DPI / 25.4);
        const mmToPrintPx = (mm) => (mm / 25.4) * PRINT_DPI;
        const pxToMm = (px) => (px / CSS_DPI) * 25.4;

        const createGapController = (rangeInput, numberInput, cssVariable) => {
            const min = Number(rangeInput.min);
            const max = Number(rangeInput.max);
            return (value) => {
                const numericValue = Number.isFinite(Number(value)) ? Number(value) : min;
                const clamped = Math.max(min, Math.min(max, numericValue));
                rangeInput.value = clamped.toString();
                numberInput.value = clamped.toString();
                workspace.style.setProperty(cssVariable, `${mmToPx(clamped)}px`);
                return clamped;
            };
        };

        const updateColumnGap = createGapController(columnGapRange, columnGapNumber, '--stereopair-column-gap');
        const updateRowGap = createGapController(rowGapRange, rowGapNumber, '--stereopair-row-gap');

        columnGapRange.addEventListener('input', (event) => updateColumnGap(event.target.value));
        columnGapNumber.addEventListener('input', (event) => updateColumnGap(event.target.value));
        rowGapRange.addEventListener('input', (event) => updateRowGap(event.target.value));
        rowGapNumber.addEventListener('input', (event) => updateRowGap(event.target.value));

        const templates = {
            'canon-selphy-1500': {
                label: 'Canon SELPHY 1500',
                workspaceWidthCm: 12.5,
                workspaceHeightCm: 11,
                columnGapMm: 8,
                rowGapMm: 12,
            },
        };

        let currentTemplate = templates[templateSelect?.value] || templates['canon-selphy-1500'];

        const formatDimension = (value) => {
            const numeric = Number(value);
            const options = {
                minimumFractionDigits: Number.isInteger(numeric) ? 0 : 1,
                maximumFractionDigits: 1,
            };
            return numeric.toLocaleString('pl-PL', options);
        };

        const applyTemplate = (templateId) => {
            const template = templates[templateId] || templates['canon-selphy-1500'];
            currentTemplate = template;
            if (templateSelect && templateSelect.value !== templateId) {
                templateSelect.value = templateId;
            }
            document.documentElement.style.setProperty('--stereopair-workspace-width', `${template.workspaceWidthCm}cm`);
            document.documentElement.style.setProperty('--stereopair-workspace-height', `${template.workspaceHeightCm}cm`);
            updateColumnGap(template.columnGapMm);
            updateRowGap(template.rowGapMm);
            if (workspaceLabel) {
                workspaceLabel.textContent = `Obszar roboczy ${formatDimension(template.workspaceWidthCm)}×${formatDimension(template.workspaceHeightCm)} cm`;
            }
            if (printStyleElement) {
                printStyleElement.textContent = `@page { size: ${template.workspaceWidthCm}cm ${template.workspaceHeightCm}cm; margin: 0; }`;
            }
        };

        if (templateSelect) {
            templateSelect.addEventListener('change', (event) => {
                applyTemplate(event.target.value);
            });
        }

        applyTemplate(templateSelect?.value || 'canon-selphy-1500');
        if (backgroundColorPicker) {
            document.documentElement.style.setProperty('--stereopair-workspace-bg', backgroundColorPicker.value);
        }

        const photoInputs = [
            {
                input: document.getElementById('photo1'),
                left: document.getElementById('photo1-left'),
                right: document.getElementById('photo1-right'),
            },
            {
                input: document.getElementById('photo2'),
                left: document.getElementById('photo2-left'),
                right: document.getElementById('photo2-right'),
            },
        ];

        const imagePromises = new Map();

        const loadImage = (src) =>
            new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => resolve(image);
                image.onerror = () => reject(new Error('Nie udało się wczytać obrazu'));
                image.src = src;
            });

        photoInputs.forEach(({ input, left, right }) => {
            const leftImage = left.querySelector('img');
            const rightImage = right.querySelector('img');

            input.addEventListener('change', (event) => {
                const file = event.target.files?.[0];
                if (!file) {
                    leftImage.removeAttribute('src');
                    rightImage.removeAttribute('src');
                    left.classList.remove('filled');
                    right.classList.remove('filled');
                    imagePromises.delete(input.id);
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    if (typeof dataUrl !== 'string') {
                        return;
                    }

                    leftImage.src = dataUrl;
                    rightImage.src = dataUrl;

                    const promise = loadImage(dataUrl)
                        .then((image) => {
                            left.classList.add('filled');
                            right.classList.add('filled');
                            return image;
                        })
                        .catch((error) => {
                            console.error(error);
                            left.classList.remove('filled');
                            right.classList.remove('filled');
                            imagePromises.delete(input.id);
                            throw error;
                        });

                    imagePromises.set(input.id, promise);
                };
                reader.readAsDataURL(file);
            });
        });

        if (backgroundColorPicker) {
            backgroundColorPicker.addEventListener('input', (event) => {
                const color = event.target.value;
                document.documentElement.style.setProperty('--stereopair-workspace-bg', color);
            });
        }

        const createRoundedRectPath = (ctx, x, y, width, height, radius) => {
            const clampedRadius = Math.min(radius, width / 2, height / 2);
            ctx.beginPath();
            ctx.moveTo(x + clampedRadius, y);
            ctx.lineTo(x + width - clampedRadius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + clampedRadius);
            ctx.lineTo(x + width, y + height - clampedRadius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - clampedRadius, y + height);
            ctx.lineTo(x + clampedRadius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - clampedRadius);
            ctx.lineTo(x, y + clampedRadius);
            ctx.quadraticCurveTo(x, y, x + clampedRadius, y);
            ctx.closePath();
        };

        const drawImageHalf = (ctx, image, half, x, y, width, height) => {
            if (!image) {
                return;
            }

            const sourceWidth = image.naturalWidth / 2;
            const sourceHeight = image.naturalHeight;
            const sourceX = half === 'left' ? 0 : sourceWidth;
            const sourceAspect = sourceWidth / sourceHeight;
            const destAspect = width / height;

            let drawWidth;
            let drawHeight;
            let offsetX;
            let offsetY;

            if (sourceAspect > destAspect) {
                drawHeight = height;
                drawWidth = height * sourceAspect;
                offsetX = (width - drawWidth) / 2;
                offsetY = 0;
            } else {
                drawWidth = width;
                drawHeight = width / sourceAspect;
                offsetX = 0;
                offsetY = (height - drawHeight) / 2;
            }

            ctx.drawImage(image, sourceX, 0, sourceWidth, sourceHeight, x + offsetX, y + offsetY, drawWidth, drawHeight);
        };

        const renderWorkspaceToImage = async () => {
            const template = currentTemplate || templates['canon-selphy-1500'];
            const printWidth = Math.round(template.workspaceWidthCm * CM_TO_INCH * PRINT_DPI);
            const printHeight = Math.round(template.workspaceHeightCm * CM_TO_INCH * PRINT_DPI);

            const canvas = document.createElement('canvas');
            canvas.width = printWidth;
            canvas.height = printHeight;

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                throw new Error('Brak wsparcia dla renderowania 2D');
            }

            const backgroundColorValue = getComputedStyle(document.documentElement)
                .getPropertyValue('--stereopair-workspace-bg')
                .trim();
            ctx.fillStyle = backgroundColorValue || '#ffffff';
            ctx.fillRect(0, 0, printWidth, printHeight);

            const workspaceStyle = getComputedStyle(workspace);
            const paddingPx = parseFloat(workspaceStyle.paddingLeft) || 0;
            const paddingMm = pxToMm(paddingPx);
            const paddingPrint = mmToPrintPx(paddingMm);

            const columnGapMm = Number(columnGapRange.value);
            const rowGapMm = Number(rowGapRange.value);
            const columnGapPrint = mmToPrintPx(columnGapMm);
            const rowGapPrint = mmToPrintPx(rowGapMm);

            const cellWidth = (printWidth - paddingPrint * 2 - columnGapPrint) / 2;
            const cellHeight = (printHeight - paddingPrint * 2 - rowGapPrint) / 2;

            const sampleHalf = document.querySelector('.stereopair-image-half');
            const halfStyle = sampleHalf ? getComputedStyle(sampleHalf) : null;
            const placeholderColor = halfStyle?.backgroundColor || 'rgba(0, 0, 0, 0.08)';
            const placeholderTextColor = halfStyle?.color || 'rgba(0, 0, 0, 0.4)';
            const borderRadiusPx = halfStyle ? parseFloat(halfStyle.borderRadius) || 0 : 0;
            const borderRadiusPrint = mmToPrintPx(pxToMm(borderRadiusPx));

            const cells = [
                { inputId: 'photo1', half: 'left', label: 'Zdjęcie 1', x: paddingPrint, y: paddingPrint },
                {
                    inputId: 'photo1',
                    half: 'right',
                    label: 'Zdjęcie 1',
                    x: paddingPrint + cellWidth + columnGapPrint,
                    y: paddingPrint,
                },
                {
                    inputId: 'photo2',
                    half: 'left',
                    label: 'Zdjęcie 2',
                    x: paddingPrint,
                    y: paddingPrint + cellHeight + rowGapPrint,
                },
                {
                    inputId: 'photo2',
                    half: 'right',
                    label: 'Zdjęcie 2',
                    x: paddingPrint + cellWidth + columnGapPrint,
                    y: paddingPrint + cellHeight + rowGapPrint,
                },
            ];

            for (const cell of cells) {
                ctx.save();
                createRoundedRectPath(ctx, cell.x, cell.y, cellWidth, cellHeight, borderRadiusPrint);
                ctx.clip();

                ctx.fillStyle = placeholderColor;
                ctx.fillRect(cell.x, cell.y, cellWidth, cellHeight);

                let image = null;
                const promise = imagePromises.get(cell.inputId);
                if (promise) {
                    try {
                        image = await promise;
                    } catch (error) {
                        console.error(error);
                        imagePromises.delete(cell.inputId);
                    }
                }

                if (!image) {
                    const fallback = document
                        .getElementById(`${cell.inputId}-${cell.half}`)
                        ?.querySelector('img');
                    if (fallback?.naturalWidth && fallback?.naturalHeight) {
                        image = fallback;
                    }
                }

                drawImageHalf(ctx, image, cell.half, cell.x, cell.y, cellWidth, cellHeight);

                if (!image) {
                    ctx.fillStyle = placeholderTextColor;
                    ctx.font = `${Math.max(cellHeight * 0.12, 24)}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(cell.label.toUpperCase(), cell.x + cellWidth / 2, cell.y + cellHeight / 2);
                }

                ctx.restore();
            }

            const separatorY = paddingPrint + cellHeight + rowGapPrint / 2;
            const separatorDash = mmToPrintPx(pxToMm(2));
            const separatorWidth = mmToPrintPx(pxToMm(2));
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.25)';
            ctx.setLineDash([separatorDash, separatorDash]);
            ctx.lineWidth = Math.max(separatorWidth, 1);
            ctx.beginPath();
            ctx.moveTo(paddingPrint, separatorY);
            ctx.lineTo(printWidth - paddingPrint, separatorY);
            ctx.stroke();
            ctx.setLineDash([]);

            return canvas.toDataURL('image/png');
        };

        saveImageButton.addEventListener('click', async () => {
            saveImageButton.disabled = true;
            saveImageButton.textContent = 'Trwa zapisywanie...';

            try {
                const dataUrl = await renderWorkspaceToImage();
                const link = document.createElement('a');
                link.download = 'stereopara.png';
                link.href = dataUrl;
                link.click();
            } catch (error) {
                console.error('Nie udało się zapisać obrazu', error);
                alert('Wystąpił błąd podczas zapisywania obrazu. Spróbuj ponownie.');
            } finally {
                saveImageButton.disabled = false;
                saveImageButton.textContent = 'Zapisz jako obraz';
            }
        });

        printButton.addEventListener('click', () => {
            window.print();
        });
    </script>

    <!-- js library start -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/----jquery.isotope.min.js"></script>
    <script src="js/----jquery.fancybox.min.js"></script>
    <script src="js/jquery.counterup.min.js"></script>
    <script src="js/waypoints.min.js"></script>
    <script src="js/magnific.popup.js"></script>
    <script src="js/----wow.min.js"></script>
    <script src="js/script.js"></script>
    <script src="js/lightbox.min.js"></script>
    <!-- js library end -->

</body>

</html>
